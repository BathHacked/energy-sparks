<h1>DCC Consents</h1>

<h2>Total schools with DCC consents: <%= @total_schools_with_consents %></h2>
<h2>Total meters with DCC consents: <%= @total_meters_with_consents %></h2>

<% unless @orphan_production_consents.empty? && @orphan_sandbox_consents.empty? %>

  <h2>MPANs in n3rgy list but not in our DCC records</h2>

  <% @orphan_production_consents.each do |mpxn|  %>
    <% if Meter.exists?(mpan_mprn: mpxn) %>
      <p><%= link_to mpxn, "#" %></p>
    <% else %>
      <p><%= "#{mpxn}" %></p>
    <% end %>
  <% end %>

  <% @orphan_sandbox_consents.each do |mpxn|  %>
    <% if Meter.exists?(mpan_mprn: mpxn) %>
      <p><%= link_to "#{mpxn} (sandbox)", "#" %></p>
    <% else %>
      <p><%= "#{mpxn} (sandbox)" %></p>
    <% end %>
  <% end %>

<% end %>

<br>
<br>

<% @grouped_meters.each do |school_group, school_meters| %>
  <div class="nav-anchor">
    <a name="<%= school_group.name.parameterize %>"> </a>
    <h2><%= "#{school_group.name} (#{school_meters.count} consented schools)" %></h2>
  </div>

  <table class="table">
    <thead>
    <tr>
      <th>School</th>
      <th>Consented meters</th>
      <th>MPAN</th>
      <th>Type</th>
      <th>Reviewed</th>
      <th>Consent granted?</th>
      <th>Sandbox?</th>
      <th>Active?</th>
      <th>n3rgy consented</th>
    </tr>
    </thead>
    <tbody>
    <% school_meters.each do |school, meters| %>
      <% meters.each do |meter| %>
      <tr>
        <td><%= link_to school.name, school_meters_path(school) if meter == meters.first %></td>
        <td><%= meters.count if meter == meters.first %></td>
        <td><%= link_to meter.mpan_mprn, school_meter_path(school, meter) %></td>
        <td><%= meter.meter_type.capitalize %></td>
        <td><%= link_to nice_dates(meter.meter_review.created_at), admin_school_meter_review_path(school, meter.meter_review) if meter.meter_review %></td>
        <td><%= meter.consent_granted? %></td>
        <td><%= meter.sandbox? %></td>
        <td><%= meter.active? %></td>
        <td><%= @production_consents.include?(meter.mpan_mprn.to_s) || @sandbox_consents.include?(meter.mpan_mprn.to_s) %></td>
      </tr>
      <% end %>
    <% end %>
    </tbody>
  </table>
<% end %>

